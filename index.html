<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
        <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
 integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
 crossorigin=""></script>
 <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
    </head>
    <style>
        .slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

label:nth-child(1) > div > span{
    color:red;
}

label:nth-child(2) > div > span{
    color:blue;
}
    </style>
    <body>
        <h2>Zonas con excesiva densidad de personas</h2>
        <style>
            #mapid { height: 600px; }
        </style>
        <div id="mapid"></div>
        <input type="range" min="1" max="100" value="1" class="slider" id="miFiltro">
        <span id="personascelda">Personas por celda > 1</span>
    <script>        
        function refine_interval(interval, cd, mask) {
        if (cd & mask) {
            interval[0] = (interval[0] + interval[1]) / 2;
        } else {
            interval[1] = (interval[0] + interval[1]) / 2;
        }
        }
        function decodeGeoHash(geohash) {
        var BITS = [16, 8, 4, 2, 1];
        var BASE32 = '0123456789bcdefghjkmnpqrstuvwxyz';
        var is_even = 1;
        var lat = [];
        var lon = [];
        lat[0] = -90.0;
        lat[1] = 90.0;
        lon[0] = -180.0;
        lon[1] = 180.0;
        var lat_err = 90.0;
        var lon_err = 180.0;
        for (var i = 0; i < geohash.length; i++) {
            var c = geohash[i];
            var cd = BASE32.indexOf(c);
            for (var j = 0; j < 5; j++) {
            var mask = BITS[j];
            if (is_even) {
                lon_err /= 2;
                refine_interval(lon, cd, mask);
            } else {
                lat_err /= 2;
                refine_interval(lat, cd, mask);
            }
            is_even = !is_even;
            }
        }
        lat[2] = (lat[0] + lat[1]) / 2;
        lon[2] = (lon[0] + lon[1]) / 2;        
        return [lat[2], lon[2]];
        }
        //decidir si queremos mapbox/streets-v11 o mapbox/satellite-v9
        var layerControl = false;
        var mymap = L.map('mapid').setView([39.48095740818392, -0.34156325567905377], 16);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/satellite-v9',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'sk.eyJ1IjoibGVvc2FtdSIsImEiOiJja2FjYTM0Y2sxOXo1MzRzOTd0MXBncWVwIn0.coH1l0fvvpNoMiF23Fl8SQ'
            }).addTo(mymap);
        var pisos = {};
         
        //asic ezpb85q3b
        //tonis ezpb85mz5
        //nexus ezpb86cr1
        //cpi ezpb86sr
        
        pisos[0]= L.layerGroup([L.circle(decodeGeoHash('ezpb85q3b'),{
                                color: 'red',
                                fillColor: '#f03',
                                fillOpacity: 0.5,
                                radius: 50
                            }).bindPopup('Esto es el ASIC'), 
                    L.circle(decodeGeoHash('ezpb85mz5'),{
                                color: 'red',
                                fillColor: '#f03',
                                fillOpacity: 0.5,
                                radius: 20
                            }).bindPopup('Esto es el Tonis'),
                    L.circle(decodeGeoHash('ezpb86cr1'),{
                                color: 'red',
                                fillColor: '#f03',
                                fillOpacity: 0.5,
                                radius: 10
                            }).bindPopup('Esto es Nexus'),
                    test = L.circle(decodeGeoHash('ezpb86sr'),{
                                color: 'red',
                                fillColor: '#f03',
                                fillOpacity: 0.5,
                                radius: 30
                            }).bindPopup('Esto es la CPI').setStyle("display:none"),                        
                ]);                
        pisos[1]= L.layerGroup([L.circle(decodeGeoHash('ezpb85q3b'),{
                                color: 'blue',
                                fillColor: '#30f',
                                fillOpacity: 0.5,
                                radius: 25
                            }).bindPopup('Esto es el ASIC piso 2'),                                         
                    L.circle(decodeGeoHash('ezpb86sr'),{
                                color: 'blue',
                                fillColor: '#30f',
                                fillOpacity: 0.5,
                                radius: 15
                            }).bindPopup('Esto es la CPI piso 2'),                        
                ]);
        //agregamos las capas
        mymap.addLayer(pisos[0]);
        mymap.addLayer(pisos[1]);

        //agregamos control de capas
        /*
        var capasPisos = {
            "Piso 0": pisos[0],
            "Piso 1": pisos[1]
        };*/
        
        if(layerControl === false) {
            layerControl = L.control.layers().addTo(mymap);
        }
    
        layerControl.addOverlay(pisos[0], "Piso 0 ");
        layerControl.addOverlay(pisos[1], "Piso 1 ");

        //vamos a depurar un poco esto a ver como va
        /*var popup = L.popup();

        function onMapClick(e) {
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(mymap);
        }

        mymap.on('click', onMapClick);*/

        var slider = document.getElementById("miFiltro");
        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {        
        var hidden = L.latLng(1000,1000);
        $("#personascelda")[0].innerText="Personas por celda > " + this.value;
        //mymap.removeLayer(pisos[0]._layers[41])
        for (key in mymap._layers){
            console.log(key)
            if (!mymap._layers[key].path)
            {
                try {
                    mymap._layers[key].path = mymap._layers[key].getLatLng();    
                } catch (error) {
                    
                }   
            }
            if (mymap._layers[key]._mRadius && mymap._layers[key]._mRadius< this.value)
            {
                try {
                    mymap._layers[key].setLatLng( hidden);    
                } catch (error) {
                    
                }
                
            }else{
                try {
                    mymap._layers[key].setLatLng( mymap._layers[key].path);    
                } catch (error) {
                    
                }
                
            }
        }
        }
    </script>
    </body>
</html>
